---
title: "data"
author: "Yong Lee"
date: "5/5/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# clear data
rm(list = ls())

# load packages
library(tidyverse)
library(stringr)
# I know I can use magrittr for dataset wrangling but I prefer pipe hotkey

# read in season data
season <- read_csv("raw-data/season.csv", col_types = cols())

# read in tournament data
tournament <- read_csv("raw-data/tournament.csv", col_types = cols())

# read in list data
list <- read_csv("raw-data/list.csv", col_types = cols())
```

```{r wrangle_data}
# lower case column names
names(season) <- tolower(names(season))
names(tournament) <- tolower(names(tournament))

# convert round to factor for eventual join
# create duplicate variable
tournament <- tournament %>%
  left_join(list, by = c("team" = "tournament")) %>%
  left_join(list, by = c("team_1" = "tournament")) %>%
  mutate(
    round = as.factor(round),
    duplicate = 2,
    team = season.x,
    team_1 = season.y
  )

# duplicate tournament data
# reassign team and opponent data
tournament <- tournament %>%
  uncount(duplicate, .remove = FALSE) %>%
  mutate(
    iteration = as.factor(unlist(c(sapply(tournament$duplicate, function(x) seq(1, x))))),
    opp_seed = seed,
    opp_team = team,
    opp_score = score,
    seed = ifelse(iteration == 2, seed_1, seed),
    team = ifelse(iteration == 2, team_1, team),
    score = ifelse(iteration == 2, score_1, score),
    seed_1 = ifelse(iteration == 2, opp_seed, seed_1),
    team_1 = ifelse(iteration == 2, opp_team, team_1),
    score_1 = ifelse(iteration == 2, opp_score, score_1)
  )

# select tournament variables for join
tournament <- tournament %>%
  select(year, round, reg_num = "region number", reg_name = "region name", seed:team, seed_opp = seed_1, team_opp = team_1, score_opp = score_1) %>% 
  filter(year %in% 2015:2019)

# specify rounds qualified in season data
# filter out teams that didn't qualify
# filter out teams that did not qualify after First Four round
season <- season %>%
  filter(!is.na(postseason), postseason != "R68") %>%
  mutate(
    tour_games = ifelse(postseason == "R64", 1,
      ifelse(postseason == "R32", 2,
        ifelse(postseason == "S16", 3,
          ifelse(postseason == "E8", 4,
            ifelse(postseason == "F4", 5,
              ifelse(postseason == "2ND", 6, 6)
            )
          )
        )
      )
    )
  )

# save file for visualizations
saveRDS(season, "shiny/raw-data/data_season.rds")

# convert team-level data to team-round data
# duplicate observations to mirror rounds qualified
season <- season %>%
  uncount(tour_games, .remove = FALSE) %>%
  mutate(
    round = as.factor(unlist(c(sapply(season$tour_games, function(x) seq(1, x)))))) %>%
  select(-seed, -postseason, -tour_games)

# join season and tournament datasets
data <- season %>%
  left_join(tournament, by = c("year" = "year", "round" = "round", "team" = "team"))

# trim season dataset to contain only opponent data
# join data dataset to season to include opponent statistics
# reorder variables
# assign game outcome value (1: win, 0: lose)
season <- season %>% 
  select(team:year, round, win_pct:wab_rank)
data <- data %>% 
  left_join(season, by = c("year" = "year", "round" = "round", "team_opp" = "team"), suffix = c("", "_opp")) %>% 
  select(year, round, reg_name, reg_num, team:conf, seed:score, team_opp, conf_opp, seed_opp, score_opp, win_pct:wab_rank, win_pct_opp:wab_rank_opp) %>% 
  mutate(win = ifelse(score > score_opp, 1, 0))

# check for missing data
#data %>% filter(is.na(reg_num))

# school naming conventions an issue
# too many unique mismatches
# created index list in MS Excel
# imported list, joined list to tournament dataset
# joined to season dataset using newly aligned names
# 63 games duplicated for each side for 5 years: 630 total
# check is good

# save final dataset
saveRDS(data, "shiny/raw-data/data_final.rds")
```
